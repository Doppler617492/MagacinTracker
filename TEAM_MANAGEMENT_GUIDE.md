# üë• Team Management Guide - Magacin Track

**Kompletni vodiƒç za upravljanje timovima**

---

## üéØ **PREGLED**

Sistem Magacin Track podr≈æava upravljanje timovima radnika, omoguƒáavajuƒái menad≈æerima da:
- ‚úÖ Kreiraju nove timove (parovi radnika)
- ‚úÖ Dodijele timove smjenama (A ili B)
- ‚úÖ Ureƒëuju postojeƒáe timove
- ‚úÖ Deaktiviraju timove
- ‚úÖ Prate performanse timova

---

## üîë **KO MO≈ΩE UPRAVLJATI TIMOVIMA**

### **Dozvole:**
- **ADMIN** - Sve operacije (create, update, delete)
- **SEF** - Sve operacije (create, update, delete)
- **MENADZER** - Create i update (ne mo≈æe delete)

---

## üì± **GDJE SE UPRAVLJA TIMOVIMA**

### **Admin Panel:**
```
http://localhost:5130/teams
```

### **Funkcionalnosti:**
1. **Pregled svih timova** - tabela sa ƒçlanovima, smjenom, i statusom
2. **Kreiranje novih timova** - dugme "Dodaj Tim"
3. **Ureƒëivanje timova** - dugme "Uredi" u akcijama
4. **Brisanje timova** - dugme "Obri≈°i" (samo ako nema aktivnih zadataka)
5. **Pregled performansi** - dugme "Performanse"

---

## üÜï **KREIRANJE NOVOG TIMA**

### **Koraci:**

1. **Otvorite Teams stranicu:**
   - http://localhost:5130/teams

2. **Kliknite "Dodaj Tim":**
   - Otvara se modal

3. **Popunite formu:**
   ```
   Naziv Tima:    Team B1
   Radnik 1:      [Select magacionera]
   Radnik 2:      [Select drugog magacionera]
   Smjena:        B (12:00 - 19:00)
   ```

4. **Kliknite "Kreiraj"**

### **Validacije:**
- ‚úÖ Naziv tima mora biti jedinstven
- ‚úÖ Oba radnika moraju biti aktivni magacioneri
- ‚úÖ Radnici ne smiju veƒá biti u drugom aktivnom timu
- ‚úÖ Smjena mora biti A ili B

### **Primjer putem API:**
```bash
TOKEN="<admin-token>"

curl -X POST http://localhost:8123/api/teams \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Team B1",
    "worker1_id": "<worker1-uuid>",
    "worker2_id": "<worker2-uuid>",
    "shift": "B"
  }'
```

**Response:**
```json
{
  "id": "uuid-here",
  "name": "Team B1",
  "shift": "B",
  "active": true,
  "worker1": {
    "id": "worker1-uuid",
    "first_name": "John",
    "last_name": "Doe",
    "email": "john@example.com"
  },
  "worker2": {
    "id": "worker2-uuid",
    "first_name": "Jane",
    "last_name": "Smith",
    "email": "jane@example.com"
  },
  "created_at": "2025-10-16T10:00:00Z"
}
```

---

## ‚úèÔ∏è **UREƒêIVANJE TIMA**

### **Koraci:**

1. **Na Teams stranici, kliknite "Uredi" pored tima**

2. **Promijenite ≈æeljene podatke:**
   - Naziv tima
   - Radnik 1
   - Radnik 2
   - Smjena (A/B)

3. **Kliknite "A≈æuriraj"**

### **Napomena:**
- Mo≈æete promijeniti samo neke podatke (ostali ostaju isti)
- Ne mo≈æete dodjeliti radnika koji je veƒá u drugom aktivnom timu

### **Primjer putem API:**
```bash
TEAM_ID="<team-uuid>"

# Promjena naziva
curl -X PUT http://localhost:8123/api/teams/$TEAM_ID \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name": "Team Alpha 1"}'

# Promjena smjene
curl -X PUT http://localhost:8123/api/teams/$TEAM_ID \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"shift": "B"}'

# Promjena radnika
curl -X PUT http://localhost:8123/api/teams/$TEAM_ID \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"worker2_id": "<new-worker-uuid>"}'
```

---

## üóëÔ∏è **BRISANJE (DEAKTIVIRANJE) TIMA**

### **Koraci:**

1. **Na Teams stranici, kliknite "Obri≈°i" pored tima**

2. **Potvrdite brisanje**

### **Napomena:**
- ‚ö†Ô∏è **NE MO≈ΩETE** obrisati tim koji ima aktivne zadatke!
- Tim se **deaktivira**, ne bri≈°e potpuno iz baze
- Deaktivirani timovi se ne prikazuju u listi aktivnih timova

### **Za≈°tita:**
```
‚ùå "Cannot delete team with 3 active tasks. Complete or reassign tasks first."
```

Prije brisanja tima, svi zadaci moraju biti:
- Zavr≈°eni (`done`)
- Otkazani (`cancelled`)
- Ili reassigned drugom timu/radniku

### **Primjer putem API:**
```bash
TEAM_ID="<team-uuid>"

curl -X DELETE http://localhost:8123/api/teams/$TEAM_ID \
  -H "Authorization: Bearer $TOKEN"
```

**Response:** 204 No Content (uspje≈°no)

---

## üìä **PREGLED PERFORMANSI TIMA**

### **Koraci:**

1. **Kliknite "Performanse" pored tima**

2. **Vidjet ƒáete:**
   - Ukupno zadataka
   - Zavr≈°enih zadataka
   - Zadataka u toku
   - Stopu zavr≈°etka (%)
   - Ukupno skeniranja
   - Prosjeƒçnu brzinu (stavki/sat)

### **Primjer putem API:**
```bash
TEAM_ID="<team-uuid>"

curl -H "Authorization: Bearer $TOKEN" \
  "http://localhost:8123/api/teams/$TEAM_ID/performance"
```

**Response:**
```json
{
  "team_id": "uuid",
  "team_name": "Team A1",
  "total_tasks": 15,
  "completed_tasks": 12,
  "in_progress_tasks": 3,
  "completion_rate": 0.8,
  "total_scans": 234,
  "average_speed_per_hour": 45.5
}
```

---

## üîÑ **SCHEDULER - TIMSKO DODJELJIVANJE**

### **Kako radi:**

Kada kreirate zadu≈ænicu u Scheduleru:

1. **Pojedinaƒçno dodjeljivanje:**
   - Odaberete jednog radnika
   - Kreira se 1 zadu≈ænica
   - Ako radnik pripada timu, automatski se postavlja `team_id`

2. **Timsko dodjeljivanje:**
   - Odaberete tim
   - Kreira se 2 zadu≈ænice (za oba ƒçlana tima)
   - Oba radnika vide dokument u PWA

### **UI:**
```
[ Pojedinaƒçno ] [ Tim ]

Kada je "Tim" odabran:
  Tim: [Team A1 (Sabin & Gezim) - Smjena A ‚ñº]
```

### **Backend logika:**
- Pri kreiranju zadu≈ænice, sistem automatski tra≈æi da li radnik pripada timu
- Ako da, postavlja `team_id` u zadu≈ænicu
- Omoguƒáava team-based analitiku i progress tracking

---

## üéØ **PRIMJERI KORI≈†TENJA**

### **Scenario 1: Kreiranje tima za Smjenu B**

**Situacija:**  
Dobili ste 2 nova radnika koji ƒáe raditi podne smjene (12:00-19:00)

**Koraci:**
1. Kreirajte 2 korisnika sa rolom `MAGACIONER`
2. Otvorite http://localhost:5130/teams
3. Kliknite "Dodaj Tim"
4. Unesite:
   - Naziv: "Team B1"
   - Radnik 1: [Novi radnik 1]
   - Radnik 2: [Novi radnik 2]
   - Smjena: B
5. Kreiraj

**Rezultat:**
- Tim B1 kreiran
- Prikazuje se u Teams tablici
- Dodjeljivanje u Scheduleru sada pokazuje i Team B1

---

### **Scenario 2: Zamjena ƒçlana tima**

**Situacija:**  
Jedan radnik je oti≈°ao na godi≈°nji, treba ga zamijenit

**Koraci:**
1. Otvorite Teams stranicu
2. Kliknite "Uredi" pored tima
3. Odaberite novog radnika za Radnik 1 ili Radnik 2
4. A≈æuriraj

**Rezultat:**
- Tim sada ima novog ƒçlana
- Stari ƒçlan mo≈æe biti dodijeljen drugom timu
- Aktiv ni zadaci ostaju sa starim team_id (historija)

---

### **Scenario 3: Deaktiviranje tima (kraj sezone)**

**Situacija:**  
Sezonski radnici zavr≈°ili, tim vi≈°e nije potreban

**Koraci:**
1. Provjerite da tim nema aktivnih zadataka
2. Kliknite "Obri≈°i"
3. Potvrdite

**Rezultat:**
- Tim se deaktivira (`active = false`)
- Ne prikazuje se u listama aktivnih timova
- Historijski podaci ostaju u bazi

---

## üõ†Ô∏è **API REFERENCE**

### **Endpoints:**

| Method | Endpoint | Opis | Dozvole |
|--------|----------|------|---------|
| GET | `/api/teams` | Lista svih timova | ADMIN, SEF, MENADZER |
| GET | `/api/teams/{id}` | Detalji tima | ADMIN, SEF, MENADZER |
| GET | `/api/teams/{id}/performance` | Performanse tima | ADMIN, SEF, MENADZER |
| POST | `/api/teams` | Kreiraj tim | ADMIN, SEF, MENADZER |
| PUT | `/api/teams/{id}` | A≈æuriraj tim | ADMIN, SEF, MENADZER |
| DELETE | `/api/teams/{id}` | Deaktiviraj tim | ADMIN, SEF |

### **Request Body (Create):**
```typescript
{
  name: string;           // "Team A1"
  worker1_id: string;     // UUID
  worker2_id: string;     // UUID
  shift: "A" | "B";       // Smjena
}
```

### **Request Body (Update):**
```typescript
{
  name?: string;          // Opciono
  worker1_id?: string;    // Opciono
  worker2_id?: string;    // Opciono
  shift?: "A" | "B";      // Opciono
  active?: boolean;       // Opciono
}
```

---

## üíª **FRONTEND KOMPONENTE**

### **TeamsPage.tsx** (Admin)

**Glavne funkcionalnosti:**
- Prikaz svih timova
- Modal za kreiranje/ureƒëivanje
- Popconfirm za brisanje
- Real-time refresh (svakih 30s)

**Key Hooks:**
```typescript
const { data: teams } = useQuery(['teams'], getTeams);
const createMutation = useMutation({ mutationFn: createTeam });
const updateMutation = useMutation({ mutationFn: updateTeam });
const deleteMutation = useMutation({ mutationFn: deleteTeam });
```

**Modal Forma:**
- Input za naziv
- 2x Select za radnike (sa search funkcijom)
- Select za smjenu
- Submit dugme

---

### **SchedulerPage.tsx** (Admin)

**Team Assignment:**
```typescript
<Radio.Group value={assignmentMode}>
  <Radio.Button value="individual">Pojedinaƒçno</Radio.Button>
  <Radio.Button value="team">Tim</Radio.Button>
</Radio.Group>

{assignmentMode === 'team' && (
  <Form.Item label="Tim" name="teamId">
    <Select options={TEAMS} />
  </Form.Item>
)}
```

---

## üóÑÔ∏è **DATABASE SCHEMA**

### **Team Table:**
```sql
CREATE TABLE team (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) UNIQUE NOT NULL,
    worker1_id UUID NOT NULL REFERENCES users(id),
    worker2_id UUID NOT NULL REFERENCES users(id),
    shift VARCHAR(1) NOT NULL CHECK (shift IN ('A', 'B')),
    active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_team_worker1 ON team(worker1_id);
CREATE INDEX idx_team_worker2 ON team(worker2_id);
CREATE INDEX idx_team_active ON team(active);
```

### **Zaduznica Table (Updated):**
```sql
ALTER TABLE zaduznica 
ADD COLUMN team_id UUID REFERENCES team(id);

CREATE INDEX idx_zaduznica_team ON zaduznica(team_id);
```

---

## üîÑ **AUTOMATSKA INTEGRACIJA**

### **Kada se kreira zadu≈ænica:**

**Backend automatski:**
1. Tra≈æi tim kojem radnik pripada
2. Postavlja `team_id` u zadu≈ænicu
3. Omoguƒáava team-based analytics

**Kod:**
```python
# U zaduznice.py - create_zaduznice()
team_stmt = select(Team.id).where(
    ((Team.worker1_id == assignment.magacioner_id) | 
     (Team.worker2_id == assignment.magacioner_id))
    & (Team.active == True)
)
team_id = (await session.execute(team_stmt)).scalar_one_or_none()

zaduznica = Zaduznica(
    # ... ostala polja ...
    team_id=team_id,  # Automatski postavljen!
)
```

---

## ‚úÖ **VALIDACIJE I PRAVILA**

### **Pri kreiranju tima:**
1. ‚úÖ Naziv mora biti jedinstven
2. ‚úÖ Oba radnika moraju postojati
3. ‚úÖ Oba radnika moraju imati rolu `MAGACIONER`
4. ‚úÖ Radnici ne smiju biti u drugom aktivnom timu
5. ‚úÖ Smjena mora biti 'A' ili 'B'

### **Pri ureƒëivanju tima:**
1. ‚úÖ Novi naziv mora biti jedinstven (ako se mijenja)
2. ‚úÖ Novi radnici moraju biti validni magacioneri
3. ‚úÖ Novi radnici ne smiju biti u drugom timu

### **Pri brisanju tima:**
1. ‚úÖ Tim ne smije imati aktivne zadatke
2. ‚úÖ Samo ADMIN i SEF mogu brisati

**Aktivni zadaci = zadaci sa statusom:**
- `assigned`
- `in_progress`

**Neaktivni zadaci** (`done`, `cancelled`) **ne blokiraju brisanje**

---

## üìä **TEAM PERFORMANCE METRICS**

### **Metrike koje se prate:**

| Metrika | Opis |
|---------|------|
| Total Tasks | Ukupno dodijeljenih zadataka timu |
| Completed Tasks | Zavr≈°eni zadaci |
| In Progress | Zadaci u toku |
| Completion Rate | Stopa zavr≈°etka (0.0 - 1.0) |
| Total Scans | Ukupno barcode skeniranja oba ƒçlana |
| Avg Speed | Prosjeƒçna brzina (stavki po satu) |

### **Kako se raƒçunaju:**

**Total Tasks:**
```sql
SELECT COUNT(*) FROM zaduznica WHERE team_id = <team_id>
```

**Completed Tasks:**
```sql
SELECT COUNT(*) FROM zaduznica 
WHERE team_id = <team_id> AND status = 'done'
```

**Completion Rate:**
```
completed_tasks / total_tasks
```

**Total Scans:**
```sql
SELECT COUNT(*) FROM scanlog 
WHERE user_id IN (worker1_id, worker2_id)
```

---

## üé® **UI FEATURES**

### **Teams Table Columns:**
1. **Tim** - Naziv sa ikonom
2. **ƒålanovi** - Imena oba radnika (vertikalno)
3. **Smjena** - Tag (plavi za A, zeleni za B)
4. **Progres** - Progress bar sa brojem zadataka
5. **Status** - Badge (üü¢ Radi, ‚ö™ Neaktivan)
6. **Akcije** - Performanse, Uredi, Obri≈°i

### **Shift Status Header:**
- Aktivna smjena
- Status (Radi / Pauza / Zavr≈°eno)
- Odbrojavanje (HH:MM:SS)

### **KPI Cards:**
- Ukupno zadataka danas
- Zavr≈°enih zadataka
- Aktivni timovi
- Prosjeƒçna zavr≈°enost (%)

---

## üß™ **TESTIRANJE**

### **Test 1: Kreiranje tima**
```bash
# 1. Login kao admin
TOKEN=$(curl -s -X POST http://localhost:8123/api/auth/device-token \
  -H "Content-Type: application/json" \
  -d '{"device_id": "tv-dashboard-001", "device_secret": "service-local"}' \
  | jq -r '.access_token')

# 2. Kreiraj tim (ako imate slobodne radnike)
curl -X POST http://localhost:8123/api/teams \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Team B1",
    "worker1_id": "<uuid1>",
    "worker2_id": "<uuid2>",
    "shift": "B"
  }' | jq .

# 3. Verifikuj u bazi
docker-compose exec db psql -U wmsops -d wmsops_local -c \
  "SELECT name, shift FROM team WHERE active = true;"
```

---

### **Test 2: Ureƒëivanje tima**
```bash
TEAM_ID="<uuid>"

# Promijeni naziv
curl -X PUT http://localhost:8123/api/teams/$TEAM_ID \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name": "Team Alpha 1"}' | jq '{name, shift}'

# Verifikuj
curl -H "Authorization: Bearer $TOKEN" \
  "http://localhost:8123/api/teams/$TEAM_ID" | jq '.name'
```

---

### **Test 3: Poku≈°aj brisanja tima sa aktivnim zadacima**
```bash
TEAM_ID="<uuid>"

# Assign task to team first
# ... (use scheduler)

# Try to delete
curl -X DELETE http://localhost:8123/api/teams/$TEAM_ID \
  -H "Authorization: Bearer $TOKEN"

# Expected: HTTP 400 with error message
```

---

## üìö **BEST PRACTICES**

### **1. Imenovanje timova:**
- ‚úÖ Koristite konzistentnu ≈°emu: "Team A1", "Team A2", "Team B1"
- ‚úÖ Ukljuƒçite smjenu u naziv za lak≈°e prepoznavanje
- ‚ùå Izbjegavajte generiƒçke nazive: "Tim 1", "Grupa A"

### **2. Dodjeljivanje radnika:**
- ‚úÖ Timove kreirajte sa radnicima koji rade zajedno
- ‚úÖ Koristite radnike iste smjene
- ‚úÖ Uravnote≈æite optereƒáenje izmeƒëu timova

### **3. Smjene:**
- **Smjena A:** 08:00-15:00 (pauza 10:00-10:30)
- **Smjena B:** 12:00-19:00 (pauza 14:00-14:30)
- **Overlap:** 12:00-15:00 (oba tima aktivna)

### **4. Lifecycle timova:**
```
Kreiran ‚Üí Aktivan ‚Üí Zadaci dodijeljeni ‚Üí Zavr≈°eni ‚Üí Deaktiviran
```

---

## üö® **TROUBLESHOOTING**

### **Problem: Ne mogu kreirati tim**
**Gre≈°ka:** "One or both workers are already in an active team"

**Rje≈°enje:**
1. Provjerite koji timovi su aktivni
2. Deaktivirajte stari tim ili odaberite druge radnike

---

### **Problem: Ne mogu obrisati tim**
**Gre≈°ka:** "Cannot delete team with X active tasks"

**Rje≈°enje:**
1. Provjerite aktivne zadatke:
   ```sql
   SELECT z.id, z.status FROM zaduznica z
   WHERE z.team_id = '<team-uuid>'
   AND z.status IN ('assigned', 'in_progress');
   ```
2. Zavr≈°ite ili reassign-ujte zadatke
3. Poku≈°ajte ponovo

---

### **Problem: Radnik ne vidi tim u PWA**
**Moguƒái uzroci:**
- Radnik nije ƒçlan nijednog aktivnog tima
- Tim je deaktiviran

**Rje≈°enje:**
```sql
-- Provjerite team membership
SELECT t.name, t.shift, t.active
FROM team t
WHERE t.worker1_id = '<user-uuid>' 
   OR t.worker2_id = '<user-uuid>';
```

---

## üìà **STATISTIKE I ANALITIKA**

### **Team Dashboard:**
```
GET /api/dashboard/live?scope=day
```

**Response sadr≈æi:**
- `total_tasks_today` - Ukupno zadataka danas
- `completed_tasks` - Zavr≈°eni zadaci
- `active_teams` - Broj aktivnih timova
- `team_progress` - Niz sa progress svakog tima:
  ```json
  {
    "team": "Team A1",
    "team_id": "uuid",
    "members": ["Sabin", "Gezim"],
    "completion": 0.75,
    "shift": "A",
    "tasks_total": 10,
    "tasks_completed": 7
  }
  ```

---

## üéØ **KLJUƒåNE PREDNOSTI TEAM MANAGEMENTA**

### **Za menad≈æere:**
1. ‚úÖ Centralizovano upravljanje parovima radnika
2. ‚úÖ Brza dodjela zadataka cijelom timu
3. ‚úÖ Team-based analytics
4. ‚úÖ Shift-based organizacija

### **Za radnike:**
5. ‚úÖ Vide ko je njihov partner
6. ‚úÖ Dijele napredak na zadacima
7. ‚úÖ Bolja koordinacija

### **Za sistem:**
8. ‚úÖ Konzistentni podaci
9. ‚úÖ Automatsko postavljanje team_id
10. ‚úÖ Lako pro≈°irenje (dodavanje novih timova)

---

## üéä **TEAM MANAGEMENT JE KOMPLETAN!**

**Sve funkcionalnosti implementirane:**
- ‚úÖ CRUD operacije (Create, Read, Update, Delete)
- ‚úÖ Validacije i za≈°tite
- ‚úÖ UI sa modalima i formama
- ‚úÖ API endpoints
- ‚úÖ Automatska integracija u Scheduler
- ‚úÖ Performance tracking
- ‚úÖ Real-time updates

**Mo≈æete odmah poƒçeti koristiti:**
http://localhost:5130/teams

**U≈æivajte!** üöÄ‚ú®

